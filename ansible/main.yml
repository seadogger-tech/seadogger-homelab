---
- hosts: cluster
  gather_facts: true
  become: true
  handlers:
    - name: reboot-pi
      ansible.builtin.reboot:
  tasks:
    - name: Configure Raspberry Pi Cluster
      import_tasks: tasks/raspberry_pi_config.yml
      when: enable_raspberry_pi_config | default(true)

- hosts: control_plane
  gather_facts: false
  become: true
  handlers:
    - name: reboot-pi
      ansible.builtin.reboot:
  vars_files:
    - config.yml
  tasks:
    - name: Deploy and Configure k3s control plane
      import_tasks: tasks/k3s_control_plane.yml
      when: enable_k3s_control_plane | default(true)

- hosts: nodes
  gather_facts: false
  become: true
  handlers:
    - name: reboot-pi
      ansible.builtin.reboot:
  vars_files:
    - config.yml
  tasks:
    - name: Deploy and Configure k3s workers
      import_tasks: tasks/k3s_workers.yml
      when: enable_k3s_workers | default(true)

- hosts: control_plane
  gather_facts: false
  become: true
  vars_files:
    - config.yml
  tasks:
    - name: Deploy MetalLB Natively
      import_tasks: tasks/metallb_native_deploy.yml
      when: enable_metallb_native | default(true)

    - name: Deploy Rook-Ceph - Part 1 (Core Components)
      import_tasks: tasks/rook_ceph_deploy_part1.yml
      when: enable_rook_ceph_part1 | default(false)

    - name: Deploy ArgoCD Natively
      import_tasks: tasks/argocd_native_deploy.yml
      when: enable_argocd_native | default(true)

# -------------------------------
# Namespace Pre-cooking
# -------------------------------
- hosts: control_plane
  become: true
  vars_files:
    - config.yml
  tasks:
    - name: Pre-cook Namespaces
      import_tasks: tasks/namespaces_precook.yml

# -------------------------------
# Internal PKI deployment (fixed)
# -------------------------------
- hosts: control_plane
  gather_facts: true         # ensure facts available for any conditionals your tasks use
  become: true
  vars:
    # Store CA material under /root/pki to avoid /tmp issues
    root_ca_key_path: "/root/pki/internal-root-ca.key"
    root_ca_cert_path: "/root/pki/internal-root-ca.crt"
    intermediate_ca_key_path: "/root/pki/internal-intermediate-ca.key"
    intermediate_ca_csr_path: "/root/pki/internal-intermediate-ca.csr"
    intermediate_ca_cert_path: "/root/pki/internal-intermediate-ca.crt"

    # Validities & key sizes
    ca_validity_root: "3650"          # 10 years
    ca_validity_intermediate: "730"   # 2 years
    key_size_root: "4096"
    key_size_intermediate: "2048"
  tasks:
    - name: Deploy Internal PKI Infrastructure
      import_tasks: tasks/internal_pki_deploy.yml
      when: enable_internal_pki | default(true)

- hosts: control_plane
  become: true
  vars_files:
    - config.yml
  tasks:
    - name: Deploy Prometheus
      import_tasks: tasks/prometheus_deploy.yml
      when: enable_prometheus | default(true)

    - name: Deploy Rook-Ceph - Part 2 (NFS Server)
      import_tasks: tasks/rook_ceph_deploy_part2.yml
      when: enable_rook_ceph_part2 | default(false)

    - name: Deploy Bedrock Gateway
      import_tasks: tasks/bedrock_gateway_deploy.yml
      when: enable_bedrock | default(true)

    - name: Deploy PiHole
      import_tasks: tasks/pihole_deploy.yml
      when: enable_pihole | default(true)

    - name: Deploy OpenWebUI
      import_tasks: tasks/openwebui_deploy.yml
      when: enable_openwebui | default(true)

    - name: Deploy n8n
      import_tasks: tasks/n8n-deploy.yml
      when: enable_n8n | default(true)

    - name: Deploy PlexMediaServer
      import_tasks: tasks/plexmediaserver_deploy.yml
      when: enable_plex | default(true)

    - name: Deploy Nextcloud
      import_tasks: tasks/nextcloud_deploy.yml
      when: enable_nextcloud | default(true)